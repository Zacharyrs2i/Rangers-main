<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rangers HQ | Discord</title>
  <meta name="description" content="Join the Rangers Discord and see live activity and member stats." />
  <meta property="og:title" content="Rangers HQ" />
  <meta property="og:description" content="Join the Rangers Discord and see live activity and member stats." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="." />
  <link rel="preconnect" href="https://discord.com">
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root {
      --brand: #2f855a; /* ranger green */
      --brand-contrast: #ffffff;
      --radius: 16px;
      --shadow: 0 8px 28px rgba(0,0,0,.25);
    }
    /* Themes */
    [data-theme="dark"]{
      --bg: #0b0f14; --panel:#111823; --muted:#9aa4b2; --chip:#0f1722; --text:#e6edf3; --ring:#1f2937;
    }
    [data-theme="light"]{
      --bg: #f7f7fb; --panel:#ffffff; --muted:#5b6b7a; --chip:#f0f3f8; --text:#0f172a; --ring:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    /* Layout */
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 18px;background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);position:sticky;top:12px;backdrop-filter:saturate(140%) blur(6px)}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
    .brand img{width:36px;height:36px;border-radius:9px;object-fit:cover;outline:2px solid var(--ring)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:999px;padding:.75rem 1.1rem;font-weight:700;text-decoration:none;cursor:pointer;transition:transform .05s ease}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--brand);color:var(--brand-contrast)}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--ring)}
    .hero{margin-top:18px;display:grid;grid-template-columns:1.2fr .8fr;gap:22px}
    @media (max-width:920px){.hero{grid-template-columns:1fr}}
    .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card.pad{padding:22px}
    .title{font-size:clamp(28px,4vw,44px);margin:0 0 6px}
    .subtitle{color:var(--muted);margin:0 0 18px}
    .stats{display:flex;gap:16px;flex-wrap:wrap;margin:14px 0 18px}
    .stat{flex:1 1 180px;background:var(--chip);border-radius:12px;padding:16px;text-align:center}
    .stat .label{opacity:.7;font-size:14px}
    .stat .num{font-size:34px;font-weight:800}
    .panel-title{font-size:18px;margin:0 0 12px}
    iframe{width:100%;height:480px;border:0;border-radius:12px;background:#0c1320}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-top:22px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}
    .footer{margin:22px 0;color:var(--muted);font-size:14px;text-align:center}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{appearance:none;width:42px;height:24px;border-radius:999px;background:var(--chip);position:relative;outline:1px solid var(--ring);cursor:pointer}
    .switch input::after{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:var(--text);transition:left .18s ease}
    .switch input:checked{background:var(--brand)}
    .switch input:checked::after{left:21px;background:var(--brand-contrast)}
    .note{font-size:13px;color:var(--muted)}
    input[type="search"], select{padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:var(--chip);color:var(--text)}
  </style>
</head>
<body>
  <div class="container">
    <!-- NAVBAR -->
    <nav class="nav">
      <div class="brand">
        <img src="/logo.png" alt="Rangers logo" onerror="this.style.display='none'">
        <span>Rangers HQ</span>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <label class="switch" title="Toggle light/dark">
          <input id="themeToggle" type="checkbox" aria-label="Toggle theme">
          <span>Theme</span>
        </label>
        <a class="btn btn-ghost" href="#live">Live</a>
        <a class="btn btn-ghost" href="#matches">Matches</a>
        <a class="btn btn-primary" href="https://discord.gg/uNmdfUJRVw" target="_blank" rel="noopener">Join Discord</a>
      </div>
    </nav>

    <!-- HERO / LEFT: summary; RIGHT: widget -->
    <section class="hero">
      <div class="card pad">
        <h1 class="title">Squad up. Roll out. ðŸ’¥</h1>
        <p class="subtitle">Your one-stop hub for the Rangers Discordâ€”live presence, member counts, match archive, and quick join access.</p>

        <div class="stats" role="group" aria-label="Server stats">
          <div class="stat">
            <div class="label">Members</div>
            <div class="num" id="members">â€”</div>
          </div>
          <div class="stat">
            <div class="label">Online</div>
            <div class="num" id="online">â€”</div>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a class="btn btn-primary" href="https://discord.gg/uNmdfUJRVw" target="_blank" rel="noopener">Join the Discord</a>
          <button class="btn btn-ghost" id="refreshBtn" type="button">Refresh stats</button>
          <label class="switch" title="Auto-refresh stats every 60s" style="align-self:center">
            <input id="autoRefresh" type="checkbox" aria-label="Toggle auto refresh">
            <span>Auto-refresh</span>
          </label>
        </div>
        <p class="note" id="lastUpdated">Last updated: â€”</p>
      </div>

      <div id="live" class="card pad">
        <h3 class="panel-title">Live Now</h3>
        <iframe src="https://discord.com/widget?id=1347988710695895181&theme=dark"
                allowtransparency="true"
                sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
        <p class="note">If this panel is empty, ensure the Discord server widget is enabled in Server Settings â†’ Integrations â†’ Widget.</p>
      </div>
    </section>

    <!-- MATCHES SECTION -->
    <section id="matches" class="grid" style="margin-top:22px">
      <div class="card pad" style="grid-column:1/-1">
        <h3 class="panel-title">Past Matches</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px">
          <input id="q" type="search" placeholder="Search opponent, map, modeâ€¦" style="flex:1 1 260px">
          <select id="resultFilter">
            <option value="">All Results</option>
            <option>Win</option>
            <option>Loss</option>
            <option>Draw</option>
          </select>
        </div>
        <div id="matchesList" class="grid" style="grid-template-columns:1fr 1fr;gap:16px"></div>
        <p class="note" style="margin-top:12px">Edit matches in our <strong>Google Sheet</strong> (published as CSV). Columns: <code>date, opponent, mode, map, result, score, vod, vod2, vod3, clip1, clip2, report, notes</code>. Newest first.</p>
      </div>
    </section>

    <!-- EXTRA PANELS (placeholders for future content) -->
    <section class="grid">
      <div class="card pad">
        <h3 class="panel-title">About the Rangers</h3>
        <p>We run coordinated ops, training, and casual squads. Keep comms clear, keep it fun, and watch your sectors. ðŸ«¡</p>
      </div>
      <div class="card pad">
        <h3 class="panel-title">How to Join</h3>
        <ol style="margin:0;padding-left:18px">
          <li>Click <strong>Join Discord</strong>.</li>
          <li>Verify in the entry channel.</li>
          <li>Hop into voice when you're ready to roll.</li>
        </ol>
      </div>
    </section>

    <p class="footer">Â© <span id="year"></span> Rangers. Not affiliated with Discord.</p>
  </div>

  <script>
    // ---- Theme toggle ----
    const themeToggle = document.getElementById('themeToggle');
    const storedTheme = localStorage.getItem('rangers-theme');
    if (storedTheme) {
      document.documentElement.setAttribute('data-theme', storedTheme);
      themeToggle.checked = storedTheme === 'light';
    }
    themeToggle.addEventListener('change', () => {
      const mode = themeToggle.checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem('rangers-theme', mode);
    });

    // ---- Server stats via public Invite API ----
    const INVITE_CODE = 'uNmdfUJRVw';
    const membersEl = document.getElementById('members');
    const onlineEl  = document.getElementById('online');
    const lastEl    = document.getElementById('lastUpdated');
    const refreshBtn= document.getElementById('refreshBtn');
    const autoRefreshToggle = document.getElementById('autoRefresh');
    let autoTimer = null;

    async function loadCounts() {
      try {
        const res = await fetch(`https://discord.com/api/v10/invites/${INVITE_CODE}?with_counts=true`, {mode:'cors'});
        if (!res.ok) throw new Error('HTTP '+res.status);
        const d = await res.json();
        membersEl.textContent = d.approximate_member_count ?? 'â€”';
        onlineEl.textContent  = d.approximate_presence_count ?? 'â€”';
        lastEl.textContent    = 'Last updated: ' + new Date().toLocaleTimeString();
      } catch (e) {
        console.warn('Discord counts fetch failed:', e);
        lastEl.textContent = 'Last updated: failed';
      }
    }

    function startAuto(){
      if (autoTimer) clearInterval(autoTimer);
      if (autoRefreshToggle && autoRefreshToggle.checked){
        autoTimer = setInterval(loadCounts, 60000);
      }
    }

    if (refreshBtn) refreshBtn.addEventListener('click', loadCounts);
    if (autoRefreshToggle) autoRefreshToggle.addEventListener('change', startAuto);

    // Initial boot
    loadCounts();
    startAuto();

    // Year
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---- Matches from Google Sheet (CSV) ----
    const SHEET_ID = '1zjj_HKjjHrFQAeOYaCrxswn4cYbf4uqGzi8h0_TX5NY';
    const SHEET_NAME = 'Matches';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

    function parseCSV(text){
      const rows=[]; let i=0, field='', row=[], inQ=false;
      while(i<text.length){
        const c=text[i];
        if(inQ){
          if(c==='"' && text[i+1]==='"'){ field+='"'; i++; }
          else if(c==='"'){ inQ=false; }
          else { field+=c; }
        }else{
          if(c==='"'){ inQ=true; }
          else if(c===','){ row.push(field.trim()); field=''; }
          else if(c==='\n'){ row.push(field.trim()); rows.push(row); row=[]; field=''; }
          else if(c==='\r'){ /* ignore */ }
          else { field+=c; }
        }
        i++;
      }
      if(field.length||row.length) { row.push(field.trim()); rows.push(row); }
      return rows;
    }

    async function loadMatches(){
      try{
        const res = await fetch(CSV_URL, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const csv = await res.text();
        const rows = parseCSV(csv);
        if(!rows.length) throw new Error('No rows');
        const headers = rows[0].map(h=>h.toLowerCase());
        const idx = (name)=> headers.indexOf(name);
        const items = rows.slice(1).filter(r=>r.some(Boolean)).map(r=>{
          const get=(k)=>{ const j=idx(k); return j>-1? r[j]||'':'' };
          const vods = [get('vod'), get('vod2'), get('vod3')].filter(Boolean);
          const clips= [get('clip1'), get('clip2')].filter(Boolean);
          return {
            date: get('date'),
            opponent: get('opponent'),
            mode: get('mode'),
            map: get('map'),
            result: get('result'),
            score: get('score'),
            vods: vods.length? vods : undefined,
            clips: clips.length? clips : undefined,
            report: get('report'),
            notes: get('notes')
          };
        });
        items.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
        renderMatches(items);
        // Filters
        const q = document.getElementById('q');
        const rf= document.getElementById('resultFilter');
        const apply=()=>{
          const term=(q.value||'').toLowerCase();
          const want=rf.value;
          const filtered = items.filter(m=>{
            const hay = [m.opponent,m.map,m.mode,m.notes].join(' ').toLowerCase();
            const okTerm = !term || hay.includes(term);
            const okRes  = !want || (m.result||'').toLowerCase()===want.toLowerCase();
            return okTerm && okRes;
          });
          renderMatches(filtered);
        };
        q.addEventListener('input', apply);
        rf.addEventListener('change', apply);
      }catch(e){
        console.warn('Google Sheet CSV not found or invalid', e);
        document.getElementById('matchesList').innerHTML = '<p class="note">No matches yet. Publish your Google Sheet as CSV and ensure headers match exactly.</p>';
      }
    }

    function renderMatches(list){
      const wrap = document.getElementById('matchesList');
      if(!list.length){ wrap.innerHTML = '<p class="note">No matches match your filters.</p>'; return; }
      wrap.innerHTML = list.map(m=>{
        const date = m.date ? new Date(m.date+'T00:00:00').toLocaleDateString() : 'â€”';
        // Build link buttons (supports multiple VODs + clips)
        let links = [];
        const makeBtn = (url, label)=>`<a href="${url}" target="_blank" rel="noopener" class="btn btn-ghost" style="padding:.45rem .75rem">${label}</a>`;
        const labelFor = (url, i)=>{
          try{ const u = new URL(url); const h = u.hostname;
            if(h.includes('twitch')) return `Twitch VOD${i>1?` ${i}`:''}`;
            if(h.includes('youtube')||h.includes('youtu.be')) return `YouTube VOD${i>1?` ${i}`:''}`;
          }catch(e){}
          return `VOD${i>1?` ${i}`:''}`;
        };
        if (Array.isArray(m.vods)) m.vods.forEach((v,i)=>{ if(v) links.push(makeBtn(v, labelFor(v, i+1))); });
        if (Array.isArray(m.clips)) m.clips.forEach((c,i)=>{ if(c) links.push(makeBtn(c, `Clip ${i+1}`)); });
        if (m.report) { links.push(makeBtn(m.report, 'Report')); }
        return `
        <article class="card pad">
          <header style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px">
            <strong>${m.opponent||'Opponent'}</strong>
            ${m.result?`<span style="padding:.2rem .55rem;border-radius:999px;background:var(--chip);border:1px solid var(--ring);font-weight:700">${m.result}</span>`:''}
          </header>
          <div style="color:var(--muted);font-size:14px;margin-bottom:10px">
            <span>${date}</span>
            ${m.mode?` Â· ${m.mode}`:''}
            ${m.map?` Â· ${m.map}`:''}
            ${m.score?` Â· Score: ${m.score}`:''}
          </div>
          <p style="margin:0 0 10px">${m.notes||''}</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">${links.join('')}</div>
        </article>`;
      }).join('');
    }

    loadMatches();
  </script>
</body>
</html>
